<html>
 <head>
  <title>Stimmabgabe</title>
  <link type="text/css" href="css/smoothness/jquery-ui-1.8.12.custom.css" rel="stylesheet" />
  <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
  <script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>
  <script type="text/javascript" src="js/jquery-ui-1.8.12.custom.min.js"></script>
  <script type="text/javascript" src="js/jquery.ui.datepicker-de.js"></script>
  <script type="text/javascript" src="js/jquery.timers-1.2.js"></script>
  <script type="text/javascript">
   $(function() {
    $("#suchtext").autocomplete({source: "action/autocomplete.php"});
    $("#wStudiengang").autocomplete({source: "action/studiengang.php"});
    $("#wFak").autocomplete({source: "action/fakultaet.php"});
    $.datepicker.setDefaults($.datepicker.regional['de']);
    $("#wGeburtsdatum").datepicker({dateFormat: 'yy-mm-dd'});
    $("#studentenwerkDialog").dialog({ autoOpen: false, modal: true, minWidth: 600,
                                       close: function(event, ui) { return onStudentenwerkDialogClose(); },
                                       open: function(event, ui) { return onStudentenwerkDialogOpen(); } });
    $( "#tabs" ).tabs({
     show: function (event, ui) {
      $('#suchtext').autocomplete( "close" );
      if (ui.panel.id == "Suchen") {
       $('#suchtext').val("");
       $('#suchtext').autocomplete( "enable" );
       $('#suchtext').focus();
      } else {
       $('#suchtext').autocomplete( "disable" );
      }
     }
    });
    ausgabeBereinigen();
    checkAuth();
    $(document).everyTime("10s", function() { checkAuth(); });
   });
   /* header */
   function checkAuth() {
    $.post("action/checkauth.php").success(function(r) {
       $('#loginbar').text('Sie sind als ' + r + ' authentifiziert.');
       $('#loginbar').append('&nbsp;<a href="./action/relogin.php?nouser=' + escape(r) + '">Logout</a>');
     } ).error(function() {
       $('#loginbar').text('Sie sind nicht authentifiziert.');
     });
   }
   /* lookup => table */
   function search() {
    var text = $("#suchtext").val();
    if (text.length < 3) {
      alert("Zu wenig Text.");
      $('#suchtext').focus();
      return;
    }
    $( "#tabs").tabs( "option", "disabled", [2,3] );
    $( "#tabs").tabs('select', '#Suchergebnis');
    $( "#tabs").tabs( "option", "disabled", [2,3] );
    var data = {
     term: text
    };
    $.post("action/suche.php", data, function(r, textStatus, jqXHR) {
      $('#searchResultTable .dataRow').remove();
      if (r.length == 0) {
        alert('Kein Eintrag gefunden.');
        ausgabeBereinigen();
        $( "#tabs").tabs('select', '#Suchen');
      } else if (r.length == 1) {
        selectPerson(r[0].id, false);
      } else {
        jQuery.each(r, function(i, val) {
          $('#searchResultTable tr:last').after('<tr class="dataRow" onClick="selectPerson('+val.id+', true);"><td>'+val.name+'</td><td>'+val.geburtsdatum+'</td></tr>');
        });
     }
    }).error(function(r) {
     alert("Die Suche ist fehlgeschlagen.\n"+r.responseText);
     $( "#tabs").tabs('select', '#Suchen');
    });
   }
   /* hand over to verify */
   function selectPerson(id, enableSearch) {
    clearAbstimmen();
    var data = {
     id: id
    };
    $.post("action/abruf.php", data, function(r, textStatus, jqXHR) {
     $('#verifyID').text(r.id);
     $('#verifyFAKID').text(r.fakId);
     $('.verifyName').text(r.name);
     $('.verifyGeburtsdatum').text(r.geburtsdatum);
     $('.verifyFak').text(r.fak);
     $('.verifyStud').text(r.stud);
     //$('.verifyWohnheim').text("");
     var msg = "Die Abstimung ist möglich.";
     var flag = 0;
     if (r.registriert == 0) {
       msg = "Die Person ist nicht zur Abstimmung zugelassen.";
       flag = 1;
     } else if (r.abgestimmt > 0) {
       msg = "Die Person hat bereits abgestimmt.";
       flag = 1;
     }
     $('.verifyStatus').text(msg);
     var tabsEnabled = (enableSearch ? [3] : [1,3]);
     $( "#tabs").tabs( "option", "disabled", tabsEnabled );
     $( "#tabs").tabs('select', '#Ueberprüfung');
     $( "#tabs").tabs( "option", "disabled", tabsEnabled );
     if (flag == 1) {
       $('#verifyID').text("-1");
       alert(msg);
       $('#verifyOkButton').attr('disabled','disabled');
       $('.verifyStatus').addClass("verifyDenied");
     } else {
     // $("#studentenwerkDialog").dialog('open');
        /* StuWe Dialog übersprunge BEGIN */
        $('#verifyOkButton').removeAttr('disabled');
        $('.verifyStatus').addClass("verifyPassed");
        /* quick&dirty fix to skip over to Ausgabe tab */
        jetztAbstimmen();
        /* StuWe Dialog übersprunge END */
     }
    }).error(function(r) {
     alert("Der Aufruf ist fehlgeschlagen.\n"+r.responseText);
     $( "#tabs").tabs('select', '#Suchen');
    });
   }
   var dialogIntededToClose;
   function onStudentenwerkDialogOpen() {
    dialogIntededToClose = false;
   }
   function onStudentenwerkDialogClose() {
    if (!dialogIntededToClose) {
     // default ESC=no
     onStudentenwerkEntscheidung(false);
    }
   }
   function onStudentenwerkEntscheidung(imStudentenwerk) {
     dialogIntededToClose = true;
     $("#studentenwerkDialog").dialog('close');
     if (imStudentenwerk) {
       $('.verifyWohnheim').text("Ja");
     } else {
       $('.verifyWohnheim').text("Nein");
     }
     $('#verifyOkButton').removeAttr('disabled');
     $('.verifyStatus').addClass("verifyPassed");
     /* quick&dirty fix to skip over to Ausgabe tab */
     jetztAbstimmen();
   }
   /* Abstimmen */
   function clearAbstimmen() {
     $('#Ausgabe .zettel').attr('class','zetteldisabled');
     $('.verifyStatus').removeClass("verifyDenied");
     $('.verifyStatus').removeClass("verifyPassed");
   }
   function jetztAbstimmen() {
    var id = $('#verifyID').text();
    if (id == -1 || id == '') {
      alert("Es liegen keine Daten vor oder die Abstimmung wäre unzulässig.");
      return;
    }
    // enable target tab
    $( "#tabs").tabs( "option", "disabled", [0,1,2,4] );
    // switch
    $( "#tabs").tabs('select', '#Ausgabe');
    // disable source tab
    $( "#tabs").tabs( "option", "disabled", [0,1,2,4] );

    /** LOGIK FÜR STIMMZETTEL **/
    // 1. StuRa, GLSR: für alle Studierenden
    $('#stura').attr('class','zettel');
    $('#ursatzung').attr('class','zettel');
    $('#urfinanz').attr('class','zettel');
    $('#glsr').attr('class','zettel');
    // 2. FakRat+FSR für Fakultät
    fak = $('#verifyFAKID').text().toUpperCase();
    if (fak == "M") {
      fak = "MB";
    }
    $('#fakrat'+fak).attr('class','zettel');
    $('#fsr'+fak).attr('class','zettel');
    // 3. Institutsrat Werkstoffwissenschaften für Werkstoffwissenschaftler
    stud = $('#verifyStud').text();
    if (stud == 'WSW') {
      $('#instwk').attr('class','zettel');
    }
    if (stud == 'TPH') {
      $('#instpk').attr('class','zettel');
    }
    // 4. BelegA
//    if ($('#verifyWohnheim').text() == 'Ja') {
//      $('#belega').attr('class','zettel');
//    }
   }
   function ausgabeAbbruch() {
    ausgabeBereinigen();
   }
   function ausgabeSpeichern() {
    $('#Ausgabe button').attr("disabled","disabled");
    var zettel = Array();
    var r = $('#Ausgabe .zettel');
    jQuery.each(r, function(i, val) {
     var id = $(val).attr('id');
     zettel.push(id);
    });
    var data = {
     id: $("#verifyID").text(),
     zettel: zettel
    };
    $.post("action/ausgabe.php", data).success(function() {
      ausgabeBereinigen();
    }).error(function(r) {
     $('#Ausgabe button').removeAttr("disabled");
     alert("Ein Fehler ist aufgereten.\n"+r.responseText);
     if (confirm("Die Stimmabgabe ist fehlgeschlagen. Abbrechen?")) {
       ausgabeBereinigen();
     }
    });
   }
   function ausgabeBereinigen() {
    $( "#tabs").tabs( "option", "disabled", [1,2,3] );
    $( "#tabs").tabs('select', '#Suchen');
    $( "#tabs").tabs( "option", "disabled", [1,2,3] );
    $("#suchtext").val("");
    $(".emptible").text("");
    $('#Ausgabe button').removeAttr("disabled");
    $("#suchtext").focus();
   }
   /* Widerspruch */
   function clearMissing() {
     $("#wMatrikel").val("");
     $("#wVorname").val("");
     $("#wNamenszusatz").val("");
     $("#wNachname").val("");
     $("#wGeburtsdatum").val("");
     $("#wFak").val("");
     $("#wStudiengang").val("");
   }
   function saveMissing() {
    var data = {
     wMatrikel: $("#wMatrikel").val(),
     wVorname: $("#wVorname").val(),
     wNamenszusatz: $("#wNamenszusatz").val(),
     wNachname: $("#wNachname").val(),
     wGeburtsdatum: $("#wGeburtsdatum").val(),
     wFak: $("#wFak").val(),
     wStudiengang: $("#wStudiengang").val()
    };
    $.post("action/widerspruch.php", data).success(function() {
      clearMissing();
      alert("Daten wurden erfolgreich gespeichert.")
     }).error(function(r) {
      alert("Daten wurden nicht gespeichert.\n"+r.responseText)
     });
   }
  </script>
  <style type="text/css">
    #tabs > div { min-height: 600px; }
    #Suchergebnis tr:nth-child(odd)    { background-color:#eee; }
    #Suchergebnis tr:nth-child(even)   { background-color:#fff; }
    #Suchergebnis tr:hover             { background-color:#ccc; }
    .zettel { background-color: orange; margin: 10px; padding: 5px;}
    .zetteldisabled { display:none; }
    .verifyPassed { background-color: green; display: block; }
    .verifyDenied { background-color: red; display: block; }
    #fakratIA.zettel { background-color: #00EE00; }
    #fakratEI.zettel { background-color: #0066FF; }
    #fakratMB.zettel { background-color: #FF0000; }
    #fakratMN.zettel { background-color: #FF6633; }
    #fakratWW.zettel { background-color: #FFFAFA; border: thin solid black;}
    #fsrIA.zettel { background-color: #A2CD5A; }
    #fsrEI.zettel { background-color: #99CC66; }
    #fsrMB.zettel { background-color: #FFFF66; }
    #fsrMN.zettel { background-color: #F08080; }
    #fsrWW.zettel { background-color: #CDC0B0; }
    #stura.zettel { background-color: #FFFF00; }
    #ursatzung.zettel { background-color: #FFFF99; }
    #urfinanz.zettel { background-color: #BBFFFF; }
    #glsr.zettel { background-color: #FFAACC; }
    #instwk.zettel { background-color: #FFCC99; }
    #instpk.zettel { background-color: #FF6666; }
    #belega.zettel { background-color: #FFFF00; }
  </style>
 </head>
 <body>
  <div id="loginbar">&nbsp;</div>
  <div id="tabs">
   <ul>
    <li><a href="#Suchen"><span>Suchen</span></a></li>
    <li><a href="#Suchergebnis"><span>Suchergebnis</span></a></li>
    <li><a href="#Ueberprüfung"><span>Überprüfung</span></a></li>
    <li><a href="#Ausgabe"><span>Ausgabe</span></a></li>
    <li><a href="#Widerspruch"><span>Widerspruch</span></a></li>
   </ul>
  <div id="Suchen">
   <div style="display:table; height: 80%; width: 100%;">
    <div style="display:table-cell; vertical-align: middle; text-align: center;">
     <span style="font-weight: bold;">Suchtext eingeben</span>
     <form action="#" onSubmit="search(); return false;">
      <input type="text" id="suchtext" name="suchtext" style="width: 60%; min-width: 300px; margin: 10px; text-align: center; color: darkgray;"/>&nbsp;<input type="submit" value="Los"/>
     </form>
    </div>
   </div>
  </div>
  <div id="Suchergebnis">
   <table border="0" style="width: 100%;" id="searchResultTable">
    <tr>
     <th>Name</th>
     <th>Geburtsdatum</th>
    </tr>
    <tr class="dataRow">
     <td colspan="2">Kein Eintrag</td>
    </tr>
   </table>
  </div>
  <div id="Ueberprüfung">
   <table border="0" style="width: 100%;">
    <tr style="display:none;">
     <th>ID</th>
     <td class="emptible" id="verifyID"></td>
    </tr>
    <tr style="display:none;">
     <th>Fakultätskürzel</th>
     <td class="emptible" id="verifyFAKID"></td>
    </tr>
    <tr>
     <th>Name</th>
     <td class="emptible verifyName" id="verifyName"></td>
    </tr>
    <tr>
     <th>Geburtsdatum</th>
     <td class="emptible verifyGeburtsdatum" id="verifyGeburtsdatum"></td>
    </tr>
    <tr>
     <th>Fakultät</th>
     <td class="emptible verifyFak" id="verifyFak"></td>
    </tr>
    <tr>
     <th>Studiengang</th>
     <td class="emptible verifyStud" id="verifyStud"></td>
    </tr>
    <tr>
     <th>Status</th>
     <td class="emptible verifyStatus" id="verifyStatus"></td>
    </tr>
<!--
    <tr>
     <th>Wohnheim</th>
     <td class="emptible verifyWohnheim" id="verifyWohnheim"></td>
    </tr>
-->
    <tr>
     <td><form><button type="button" onClick="jetztAbstimmen();" id="verifyOkButton" accesskey="w"><u>W</u>eiter</button></form></td>
     <td><form><button type="button" onClick="ausgabeAbbruch();" id="verifyAbortButton" accesskey="a"><u>A</u>bbruch</button></form></td>
    </tr>
   </table>
  </div>
  <div id="Ausgabe">
   <table border="0" style="width: 100%;">
    <tr>
     <th>Name</th>
     <td class="emptible verifyName"></td>
    </tr>
    <tr>
     <th>Geburtsdatum</th>
     <td class="emptible verifyGeburtsdatum"></td>
    </tr>
    <tr>
     <th>Fakultät</th>
     <td class="emptible verifyFak"></td>
    </tr>
    <tr>
     <th>Studiengang</th>
     <td class="emptible verifyStud"></td>
    </tr>
    <tr>
     <th>Status</th>
     <td class="emptible verifyStatus"></td>
    </tr>
<!--
    <tr>
     <th>Wohnheim</th>
     <td class="emptible verifyWohnheim"></td>
    </tr>
-->
   </table>
  <div id="fakratIA" class="zettel">Fakultätsrat IA</div>
  <div id="fakratEI" class="zettel">Fakultätsrat EI</div>
  <div id="fakratMB" class="zettel">Fakultätsrat MB</div>
  <div id="fakratMN" class="zettel">Fakultätsrat MN</div>
  <div id="fakratWW" class="zettel">Fakultätsrat WW</div>
  <div id="fsrIA" class="zettel">Fachschaftsrat IA</div>
  <div id="fsrEI" class="zettel">Fachschaftsrat EI</div>
  <div id="fsrMB" class="zettel">Fachschaftsrat MB</div>
  <div id="fsrMN" class="zettel">Fachschaftsrat MN</div>
  <div id="fsrWW" class="zettel">Fachschaftsrat WW</div>
  <div id="stura" class="zettel">Studierendenrat</div>
  <div id="urfinanz" class="zettel">Urabstimmung Finanzordnung</div>
  <div id="ursatzung" class="zettel">Urabstimmung Satzung</div>
  <div id="glsr"  class="zettel">Gleichstellungsrat</div>
  <div id="instwk" class="zettel">Institutsrat Werkstoffwissenschaften</div>
  <div id="instpk" class="zettel">Institutsrat Physik</div>
  <div><form><button accesskey="w" type="button" id="ausgabeOkButton" onClick="ausgabeSpeichern()">Stimmzettel <u>w</u>urden ausgegeben</button> <button type="button" accesskey="a" onClick="ausgabeAbbruch();" id="ausgabeAbortButton">Ausgabe vollständig <u>a</u>bgebrochen.</button></form></div>
  </div>
  <div id="studentenwerkDialog" title="Stimmberechtigung im Wohnheim prüfen">
   Wohnt <span class="emptible verifyName" id="verifyNameDlg"></span> im Studentenwohnheim (Studentenwerk / Campus)? <br/>
   <button onClick="onStudentenwerkEntscheidung(true);">Ja, wohnt im Wohnheim</button> <button onClick="onStudentenwerkEntscheidung(false);">Nein, wohnt extern</button>
  </div>
  <div id="Widerspruch">
  Dieses Formular wird benutzt, wenn der Studierende behauptet, wahlberechtigt zu sein, im System aber nicht bekannt ist.
  <form action="#">
  <table border="0" id="widerspruchTable">
   <tr><th>Matrikelnummer</th><td><input id="wMatrikel" type="text"/></td></tr>
   <tr><th>Vorname</th><td><input id="wVorname" type="text"/></td></tr>
   <tr><th>Namenszusatz</th><td><input id="wNamenszusatz" type="text"/></td></tr>
   <tr><th>Nachname</th><td><input id="wNachname" type="text"/></td></tr>
   <tr><th>Geburtsdatum</th><td><input id="wGeburtsdatum" type="text"/></td></tr>
   <tr><th>Fakultät</th><td><input id="wFak" type="text"/></td></tr>
   <tr><th>Studiengang</th><td><input id="wStudiengang" type="text"/></td></tr>
   <tr><td><button type="button" accesskey="s" onClick="saveMissing();"><u>S</u>peichern</button></td><td><button accesskey="r" type="button" onClick="clearMissing();">Lee<u>r</u>en</button></td></tr>
  </table>
  </form>
  </div>
  </div>
 </body>
</html>
